<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chấm Phiếu Trắc Nghiệm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #canvasContainer { position: relative; display: inline-block; }
    canvas { border: 1px solid #ccc; }
    #coords { margin-top: 10px; }
    #btnClear { margin-top: 10px; }
  </style>
  <!-- Load OpenCV.js (phiên bản build mới nhất) -->
  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();" ></script>
</head>
<body>
  <h2>Chấm Phiếu Trắc Nghiệm</h2>
  <p>Chọn file ảnh phiếu trắc nghiệm của bạn:</p>
  <input type="file" id="fileInput" accept="image/*">
  <div id="canvasContainer">
    <canvas id="canvasOutput"></canvas>
  </div>
  <div>
    <button id="btnClear">Xoá vùng đã chọn</button>
  </div>
  <div id="coords">
    <h3>Tọa độ vùng đáp án đã chọn:</h3>
    <pre id="coordList"></pre>
  </div>
  <div id="message"></div>

  <script>
    let cvReady = false;
    let img = null;
    let srcMat = null;
    let cornerPoints = [];
    let answerPoints = [];
    let canvas = document.getElementById('canvasOutput');
    let ctx = canvas.getContext('2d');

    // Chờ OpenCV khởi tạo xong
    function onOpenCvReady() {
      cv['onRuntimeInitialized']= () => {
        cvReady = true;
        document.getElementById('message').innerText = 'OpenCV đã sẵn sàng.';
      }
    }

    // Xử lý file upload
    document.getElementById('fileInput').addEventListener('change', function(e) {
      if (!cvReady) {
        alert("OpenCV chưa khởi tạo xong, vui lòng đợi một chút.");
        return;
      }
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(event) {
        loadImage(event.target.result);
      }
      reader.readAsDataURL(file);
    });

    // Load ảnh vào canvas và khởi động xử lý
    function loadImage(src) {
      let image = new Image();
      image.onload = function() {
        // Cài đặt kích thước canvas bằng kích thước ảnh
        canvas.width = image.width;
        canvas.height = image.height;
        ctx.drawImage(image, 0, 0);
        // Lưu lại ảnh dưới dạng cv.Mat
        if (srcMat) srcMat.delete();
        srcMat = cv.imread(canvas);
        // Sau khi load ảnh, tự động xử lý phát hiện góc
        detectCorners();
      }
      image.src = src;
    }

    // Hàm xử lý phát hiện góc bằng OpenCV
    function detectCorners() {
      if (!srcMat) return;
      let gray = new cv.Mat();
      cv.cvtColor(srcMat, gray, cv.COLOR_RGBA2GRAY, 0);
      // Làm mờ và sử dụng Canny để phát hiện cạnh
      let blurred = new cv.Mat();
      cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
      let edges = new cv.Mat();
      cv.Canny(blurred, edges, 50, 150);
      
      // Tìm các contour
      let contours = new cv.MatVector();
      let hierarchy = new cv.Mat();
      cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
      
      // Tìm contour có diện tích lớn nhất và có thể xấp xỉ thành đa giác 3 hoặc 4 điểm
      let maxArea = 0;
      let approxContour = null;
      for (let i = 0; i < contours.size(); i++) {
        let cnt = contours.get(i);
        let area = cv.contourArea(cnt, false);
        if (area < 1000) { cnt.delete(); continue; } // loại bỏ các vùng nhỏ
        let approx = new cv.Mat();
        cv.approxPolyDP(cnt, approx, 0.02 * cv.arcLength(cnt, true), true);
        // Nếu tìm được đa giác 3 hoặc 4 điểm
        if ((approx.rows === 3 || approx.rows === 4) && area > maxArea) {
          maxArea = area;
          if (approxContour !== null) approxContour.delete();
          approxContour = approx;
        } else {
          approx.delete();
        }
        cnt.delete();
      }
      
      // Vẽ các điểm phát hiện được lên canvas
      cornerPoints = [];
      if (approxContour) {
        for (let i = 0; i < approxContour.rows; i++) {
          let point = {
            x: approxContour.intAt(i, 0),
            y: approxContour.intAt(i, 1)
          };
          cornerPoints.push(point);
        }
        approxContour.delete();
      }
      // Vẽ lên canvas: hiển thị ảnh gốc và các điểm góc
      cv.imshow('canvasOutput', srcMat);
      ctx = canvas.getContext('2d');
      ctx.fillStyle = 'red';
      ctx.strokeStyle = 'red';
      ctx.lineWidth = 3;
      cornerPoints.forEach(pt => {
        ctx.beginPath();
        ctx.arc(pt.x, pt.y, 5, 0, 2 * Math.PI);
        ctx.fill();
      });
      
      // Thông báo số điểm góc phát hiện
      let msg = cornerPoints.length > 0 ?
        `Đã phát hiện ${cornerPoints.length} điểm góc (tự động). Nếu chưa chính xác, bạn có thể click vào canvas để đánh dấu lại.` :
        'Không phát hiện được điểm góc tự động. Vui lòng click trực tiếp vào các điểm góc trên canvas.';
      document.getElementById('message').innerText = msg;
      
      // Giải phóng bộ nhớ
      gray.delete(); blurred.delete(); edges.delete(); hierarchy.delete(); contours.delete();
    }

    // Cho phép người dùng click vào canvas để đánh dấu tọa độ vùng đáp án (các ô chọn đáp án)
    canvas.addEventListener('click', function(e) {
      let rect = canvas.getBoundingClientRect();
      let x = e.clientX - rect.left;
      let y = e.clientY - rect.top;
      // Vẽ một hình tròn nhỏ tại điểm click
      ctx.fillStyle = 'blue';
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, 2 * Math.PI);
      ctx.fill();
      answerPoints.push({ x: Math.round(x), y: Math.round(y) });
      updateCoordList();
    });

    // Cập nhật danh sách tọa độ vùng đáp án
    function updateCoordList() {
      let coordList = document.getElementById('coordList');
      coordList.textContent = answerPoints.map((pt, index) => `Điểm ${index+1}: (${pt.x}, ${pt.y})`).join('\n');
    }

    // Nút xoá vùng đánh dấu đáp án
    document.getElementById('btnClear').addEventListener('click', function() {
      answerPoints = [];
      updateCoordList();
      // Vẽ lại ảnh gốc và các điểm góc tự động
      if (srcMat) cv.imshow('canvasOutput', srcMat);
      // Vẽ lại các điểm góc tự động (nếu có)
      ctx = canvas.getContext('2d');
      ctx.fillStyle = 'red';
      cornerPoints.forEach(pt => {
        ctx.beginPath();
        ctx.arc(pt.x, pt.y, 5, 0, 2 * Math.PI);
        ctx.fill();
      });
    });
  </script>
</body>
</html>
